<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Zoning Out Randomizer</title>
  <style>
   /* styles inserted by pandoc */
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>

  <style>
   /* styles specific to the randomizer */
   div.rule {
       display:none;
       border-bottom: 3px double gray;
   }
   div.rule.on {display:block;}
   td {border: 1px solid #cecece;}
   td:nth-child(even), input {text-align: right;}
   table input {width: 25px;}
   div#ruleList {
       display: none; /*grid is intended*/
       grid-template-columns: 1fr 1fr 1fr; 
       margin: 20px 10px;}
   div#ruleList label {
       display: inline-block; 
       white-space: nowrap; 
       margin-right: 25px;}
   button#unmanual {display: none;}
   tt {white-space: nowrap;}
   #alert {
       color: tomato;
       display: none;
   }
   tr.biggerCity, tr.biggestCity {display:none;}

   @media (max-width: 600px) {
       div#ruleList {
	   grid-template-columns: 1fr 1fr;
       }
   }

   /* styles for drawing pyramids */

   .info {
       font-style: italic;
       color: #444444;
   }
   span.info {font-size: smaller;}

   @font-face {
       font-family: 'PyramidLove';
       src: url('Pyramid-Love-3.1.woff');
   }

   div.draw-bags, 
   div.draw-bags button {
       font-family: 'PyramidLove' !important;
       font-size: 36px;
   }
   div.draw-bags button {
       display: inline-block;
       background-color: #7A5F8D; /*#797979;*/
       color: #ffffff;
       text-align: center;
       border: 4px double #cccccc;
       border-radius: 15px;
   }
   div.draw-bags button:active {
       background-color: #CC6FCC;
   }
   div.draw-bags button:hover {
       background-color: #A86AA7;
   }
   div.draw-bags button.off, 
   div.draw-bags button.off:hover {
       background-color: #D6D6D6!important;
   }
   div.draw-bags input {width: 24px;}

   div.draw-bags span {
       -webkit-text-stroke: 1px;
       -webkit-text-stroke-color: #333;
   }
   div.draw-bags span.red {-webkit-text-fill-color: #EF8785;}
   div.draw-bags span.yellow {-webkit-text-fill-color: #FCEFB2;}
   div.draw-bags span.blue {-webkit-text-fill-color: #98E2FC;}
   div.draw-bags span.green {-webkit-text-fill-color: #CDE8B4;}
   div.draw-bags span.black {-webkit-text-fill-color: #000000;}

   div.draw-button-area {display: inline-block;}

   div.draw-button-area span {
       padding-left: 15px;
   }

  </style>

  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<p><img src="images/zoningoutheader.svg" width="600"></p>
<h1 id="zoning-out">Zoning Out Randomizer</h1>
<p>Zoning Out is a city building pyramid game for 1 or more players by Spencer Cappallo,
	along the lines of Sprawlopolis.</p>

<p>The game uses variable goals, called <em>scoring rules</em>, which this
 randomizer can choose at random.  It can can also import or select specific rules,  
 and includes a working scoresheet.</p>
<p>For your convenience, the <a href="./zoningout.html">official rules</a> are reproduced below:</p>

<details>
  <summary>Rules</summary>
<h2 id="equipment">Equipment</h2>
<ul>
<li>3 trios in each of five colors (red, green, blue, yellow,
black)</li>
<li>One bag (three bags is better, and bowls work well as an
alternative)</li>
</ul>
<h2 id="setup">Setup</h2>
<p>Place the pyramids in the bag. If using multiple bags, sort the
pyramids by size and place each size in its own bag. Choose three
special scoring rules to play with for the duration of this game. You
may draw them out of a hat randomly, or perhaps select three you’d like
to try. You are now ready to play.</p>
<h2 id="game-idea">Game Idea</h2>
<p>During the game, you will be drawing random pyramids and adding them
to your city’s grid. Pyramids represent different municipal building
zones. Red is Residential (“redsidential”), Yellow is Industrial
(“industriyellow”), Blue is Commercial (“bluemercial”), and Green is
Parks (“green space”). Black pyramids represent certain necessary, but
perhaps unpleasant to be next to, facilities such as wastewater
treatment plants and city dumps.</p>
<p>Large pyramids are large developments, and smaller ones are smaller.
You will be building out your city subject to certain constraints.
Generally, you want colors to be grouped together with the exception of
the black pieces, which you usually want touching as few pieces as
possible. Depending on which scoring rules you’re playing with, these
rules of thumb can vary, however.</p>
<p>The scoring rules you choose will have <strong>target scores</strong>
written on them. The sum of all three target scores will determine the
score you need to win.</p>
<h2 id="game-play">Game Play</h2>
<p>Every turn you will:</p>
<ul>
<li>Choose which size of pyramid to place</li>
<li>Draw a random pyramid of that size (by feel if using a single
bag)</li>
<li>Place that pyramid next to a pyramid that's already been placed --
except for your first turn, where there will of course be no other
pyramids in play.</li>
<li><strong>IMPORTANT: You may NEVER place a pyramid next to another
pyramid of the same size</strong></li>
<li><strong>IMPORTANT: Diagonals do not exist in Zoning Out.</strong>
	You may never place diagonally, and all scoring rules ignore
	diagonals.</li>
<li>In the unlikely event that you are unable to place the piece you
	drew due to there being no legal, valid placements, return that piece
	and draw a piece of a different size.</li>
</ul>
<p>When you have placed all your pyramids, proceed to scoring your new
city.</p>
</details>

<details>
<summary>Scoring</summary>

<h2 id="scoring">Scoring</h2>
<p>Scoring is as follows:</p>
<ul>
<li>Find your largest connected group (remember: no diagonals) in each
of red, blue, green, and yellow. Each of these groups scores 1 point for
every pyramid within it.</li>
<li>Now score your black pyramids. Black pyramids score negatively. They
subtract a value equal to their (size) x (the number of pyramids next to
them). So, a 3-pip (large) black pyramid with two other pyramids next to
it (of any color), would score -(3*2) = -6 points</li>
<li>Next, score your three <a href="#special-scoring-rules">special
scoring rules</a>. These scoring rules will have the details of how they
score written on them.</li>
<li>Finally, tally up your score. If your score is equal to or higher
than the sum of the target scores on all three scoring rules, you win.
If it's lower, you've lost.</li>
</ul>
<blockquote>
<p><strong>Scoring Example</strong> In this example game (played using
fewer than normal pyramids for illustrative purposes), we would score
first the largest groups in each of the four colors: Red = 4, Yellow =
3, Green = 6, and Blue = 2. This would give us 15 points. Then we
subtract all the points from black pieces: -2 + -1 + -6 + -6 + -2 + -6 =
-23. We get a basic score of -8! Note that two black pieces next to each
other both still count against their tallies. After calculating this
base score, we would then score the special scoring rules selected for
our game. <img src="images/basic_scoring.svg" width="500"></p>
</blockquote>
<p>There is a <a href="#scoring-sheet">scoring sheet</a> at the end of
this document that you can use for calculating your score.</p>

<h2 id="special-scoring-rules">Special Scoring Rules</h2>
<p>During your game you will be playing with three <!--of the--> special
scoring rules listed below. For the solo and co-operative game modes, a
target score is listed. Your goal is to build a city that scores as much
or more than the target scores of all three special scoring rules added
together. <!-- For convenience, the titles of the rules are also listed in
here with links to the rules themselves. To randomly select scoring
rules, you could write these titles on slips of paper and draw three
from a hat.--></p>
<hr />
</details>

<details>
	<summary>Variants</summary>

<h2 id="multiplayer">Multiplayer</h2>
<p>Though designed as a single player experience, there are a couple
ways to play Zoning Out with more than one player.</p>
<h3 id="co-operative">Co-operative</h3>
<p>Play exactly as described above, but take turns drawing and placing
pieces.</p>
<h3 id="competitive">Competitive</h3>
<p>You will need additional equipment for this mode. You will need
player screens (something to hide each player’s city), and you will need
additional pyramids: at least 2 trios in the five colors per player. You
can have some players use other colors (for example, the “xeno” colors)
so long as all players agree on which color correlates to which.</p>
<p>To setup, draw special scoring cards as normal. These will apply to
all players, but you will ignore the target score values. Each player
should set up all their pieces in a place near to them as a supply. On
their turn, a player <strong>chooses</strong> which piece they wish to
play next. All players must then add that same piece type to their city
(behind their screen).</p>
<p>Play continues this way until all pieces have been placed. Players
score their own city following the usual scoring procedure. Whichever
player has the highest valued city is the winner.</p>

	<h2 id="variants">Variants</h2>
	<h3 id="apc-analysis-paralysis-commission">APC: Analysis Paralysis
Commission</h3>
<p>Instead of drawing pieces randomly, shuffle the three sizes
separately and lay them out into three lines, one line for each size of
piece. During play, you can take the front piece from any line. Warning:
playing like this can turn the game into a <em>very</em> think-y puzzle.
It can also make the game easier to win, so if you find you are winning
too often, you can up the challenge by increasing the target score by a
few points whenever you play.</p>
<h3 id="small-city">Small City</h3>
<p>This variant is good for a quicker, more relaxed game. Play with only
2 trios per color, and with only 2 special scoring rules.</p>

<hr />
</details>

<h2>Selected Scoring Rules</h2>

<button type="button" id="randomize">Randomize</button> <button type="button" id="manual">Select manually</button> <button type="button" id="unmanual">Hide selection list</button> &nbsp; <div style="display:inline-block;vertical-align:top;"><label><input type="radio" name="variant" id="regularCity">Standard (3) rules</label><br/><label><input type="radio" name="variant" id="smallCity">Small City variant</label></div> &nbsp; <span id="alert">Too many rules!</span>

<div id="ruleList">
 <label><input data-ruleid="1" type="checkbox" id="#15-minute-city">&nbsp;15-Minute City</label> 
 <label><input data-ruleid="2" type="checkbox" id="#density-bonusing">&nbsp;Density Bonusing</label> 
 <label><input data-ruleid="3" type="checkbox" id="#rainbow-rows">&nbsp;Rainbow Rows</label> 
 <label><input data-ruleid="4" type="checkbox" id="#colorful-columns">&nbsp;Colorful Columns</label> 
 <label><input data-ruleid="5" type="checkbox" id="#overshadowed">&nbsp;Overshadowed</label> 
 <label><input data-ruleid="6" type="checkbox" id="#little-boxes">&nbsp;Little Boxes</label> 
 <label><input data-ruleid="7" type="checkbox" id="#shopping-district">&nbsp;Shopping District</label> 
 <label><input data-ruleid="8" type="checkbox" id="#linear-park">&nbsp;Linear Park</label> 
 <label><input data-ruleid="9" type="checkbox" id="#we-compost">&nbsp;“We Compost”</label> 
 <label><input data-ruleid="10" type="checkbox" id="#garden-city">&nbsp;Garden City</label> 
 <label><input data-ruleid="11" type="checkbox" id="#piazzas">&nbsp;Piazzas</label> 
 <label><input data-ruleid="12" type="checkbox" id="#canadian-style">&nbsp;Canadian Style</label> 
 <label><input data-ruleid="13" type="checkbox" id="#factory-un-fun">&nbsp;Factory Un-fun</label> 
 <label><input data-ruleid="14" type="checkbox" id="#lines-of-sight">&nbsp;Lines of Sight</label> 
 <label><input data-ruleid="15" type="checkbox" id="#clusters">&nbsp;Clusters</label> 
 <label><input data-ruleid="16" type="checkbox" id="#bigger-on-the-outside">&nbsp;Bigger on the Outside</label> 
 <label><input data-ruleid="17" type="checkbox" id="#mixed-use-development">&nbsp;Mixed-Use Development</label> 
 <label><input data-ruleid="18" type="checkbox" id="#room-to-make-a-big-mistake">&nbsp;Room to make a Big Mistake</label>
</div>

<div class="rule on" id="rr1" data-target="13">

<h3 id="minute-city">15-Minute City</h3>
<p><img src="images/15min.svg" width=300></p>
<p>4 points for every red piece that is next to a blue, green,
	<strong>and</strong> yellow piece.</p>
<p><strong>Target Score</strong>: 13</p>
</div>

<div class="rule on" id="rr2" data-target="-4">

<h3 id="density-bonusing">Density Bonusing</h3>
<p><img src="images/density.svg" width=300></p>
<p>-1 point for the total width or height of your city in pyramids,
whichever is larger.</p>
<p><strong>Target Score</strong>: -4</p>
</div>

<div class="rule on" id="rr3" data-target="15">

<h3 id="rainbow-rows">Rainbow Rows</h3>
<p><img src="images/rainbow_rows.svg" width=300></p>
<p>5 points for every row (relative to player’s view) that has at least
one piece in all five colors in it.</p>
<p><strong>Target Score</strong>: 15</p>
</div>

<div class="rule" id="rr4" data-target="15">

<h3 id="colorful-columns">Colorful Columns</h3>
<p><img src="images/colorful_columns.svg" width=300></p>
<p>2 points for every column with at least three different colors in it.
-3 points for any column that has less than 3 colors in it.</p>
<p><strong>Target Score</strong>: 15</p>
</div>

<div class="rule" id="rr5" data-target="-5">

<h3 id="overshadowed">Overshadowed</h3>
<p><img src="images/overshadowed.svg" width=300></p>
<p>For every small piece, -1 point for any large pieces next to it.</p>
<p><strong>Target Score</strong>: -5</p>
</div>

<div class="rule" id="rr6" data-target="9">

<h3 id="little-boxes">Little Boxes</h3>
<p><img src="images/little_boxes.svg" width=300></p>
<p>3 points for every 2x2 square of red pieces within your city. Squares
may overlap.</p>
<p><strong>Target Score</strong>: 9</p>
</div>

<div class="rule" id="rr7" data-target="9">

<h3 id="shopping-district">Shopping District</h3>
<p><img src="images/shopping_district.svg" width=300></p>
<p>3 points for every 2x2 square of blue pieces within your city.
Squares may overlap.</p>
<p><strong>Target Score</strong>: 9</p>
</div>

<div class="rule" id="rr8" data-target="13">

<h3 id="linear-park">Linear Park</h3>
<p><img src="images/linear_park.svg" width=300></p>
<p>1 point for every piece in your longest line (horizontal or vertical)
of green pieces. Only contiguous pieces within a single row or column
count.</p>
<p><strong>Target Score</strong>: 13</p>
</div>

<div class="rule" id="rr9" data-target="19">

<h3 id="we-compost">“We Compost”</h3>
<p><img src="images/we_compost.svg" width=300></p>
<p>Every black piece next to at least one red piece scores points equal
to the black piece’s size. e.g., a large black that is next to one or
more reds would score +3 points.</p>
<p><strong>Target Score</strong>: 19</p>
</div>

<div class="rule" id="rr10" data-target="17">

<h3 id="garden-city">Garden City</h3>
<p><img src="images/garden_city.svg" width=300></p>
<p>2 points for every red residential zone next to a green park.</p>
<p><strong>Target Score</strong>: 17</p>
</div>

<div class="rule" id="rr11" data-target="23">

<h3 id="piazzas">Piazzas</h3>
<p><img src="images/piazzas.svg" width=300></p>
<p>1 point for every different color (including black) around any fully
enclosed empty space within your city.</p>
<p><strong>Target Score</strong>: 23</p>
</div>

<div class="rule" id="rr12" data-target="17">

<h3 id="canadian-style">Canadian Style</h3>
<p><img src="images/canadian_style.svg" width=300></p>
<p>When playing with this card, large pieces may be placed adjacent to
other large pieces. Score 2 points for every large piece in your biggest
group of large pieces, disregarding color.</p>
<p><strong>Target Score</strong>: 17</p>
</div>

<div class="rule" id="rr13" data-target="4">

<h3 id="factory-un-fun">Factory Un-fun</h3>
<p><img src="images/factory_unfun.svg" width=300></p>
<p>-1 point for every non-yellow piece next to a yellow piece.</p>
<p><strong>Target Score</strong>: 4</p>
</div>

<div class="rule" id="rr14" data-target="4">

<h3 id="lines-of-sight">Lines of Sight</h3>
<p><img src="images/lines_of_sight.svg" width=300></p>
<p>1 point for every row or column with exactly two large pieces in it.
-2 points for any row or column with less or more than 2 large pieces in
it.</p>
<p><strong>Target Score</strong>: 4</p>
</div>

<div class="rule" id="rr15" data-target="9">

<h3 id="clusters">Clusters</h3>
<p><img src="images/clusters.svg" width=300></p>
<p>3 points for every group consisting exactly of a small, medium, and
large of a single color (red, blue, green, or yellow), and no other
pieces. -1 point for every group not composed thusly.</p>
<p><strong>Target Score</strong>: 9</p>
</div>

<div class="rule" id="rr16" data-target="15">

<h3 id="bigger-on-the-outside">Bigger on the Outside</h3>
<p><img src="images/bigger_on_the_outside.svg" width=300></p>
<p>2 points for every large piece in the rows and columns farthest to
the top and bottom, left and right, respectively.</p>
<p><strong>Target Score</strong>: 15</p>
</div>

<div class="rule" id="rr17" data-target="7">

<h3 id="mixed-use-development">Mixed-Use Development</h3>
<p><img src="images/mixed_use.svg" width=300></p>
<p>For this game, you may place a second piece on top of an existing
piece when placing. For the purposes of all other rules, these two
pieces are considered next to each other (so you may never, for example,
place a medium on top of another medium). Both pieces are also
considered next to the four spaces orthogonal to their space. For
legibility, you should arrange the pieces such that the smaller piece is
stacked on top of the larger piece.</p>
<p><strong>Target Score</strong>: 7</p>
</div>

<div class="rule" id="rr18" data-target="17">

<h3 id="room-to-make-a-big-mistake">Room to make a Big Mistake</h3>
<p><img src="images/room_to_make_a_big_mistake.svg" width=300></p>
<p>+1 point for every unoccupied space next to a red piece.</p>
<p><strong>Target Score</strong>: 17</p>
</div>


<h2 id="scoring-sheet">Scoring Sheet</h2>
<p>This table will calculate your score:</p>
<table>
<tbody>
<tr>
	<td colspan="2">Residential (red) largest group</td>
	<td><input autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" class="colorScore" id="color1" type="text"/></td>
</tr>
<tr>
	<td colspan="2">Industrial (yellow) largest group</td>
	<td><input autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" class="colorScore" id="color2" type="text"/></td>
</tr>
<tr>
	<td colspan="2">Commercial (blue) largest group</td>
	<td><input autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" class="colorScore" id="color3" type="text"/></td>
</tr>
<tr>
	<td colspan="2">Green space (green) largest group</td>
	<td><input autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" class="colorScore" id="color4" type="text"/></td>
</tr>
<tr>
	<td colspan="2"><strong>Colors SUM</strong></td>
	<td><b id="colorSubtotal" class="calced"></b></td>
</tr>
<tr>
	<td>Black: neighbors of 1-pip pyramids</td>
	<td><input autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" id="blackScore1" type="text"/></td>
	<td id="blackSubtotal1" class="calced"></td>
</tr>
<tr>
	<td>Black: neighbors of 2-pip pyramids</td>
	<td><input autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" id="blackScore2" type="text"/></td>
	<td id="blackSubtotal2" class="calced"></td>
</tr>
<tr>
	<td>Black: neighbors of 3-pip pyramids</td>
	<td><input autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" id="blackScore3" type="text"/></td>
	<td id="blackSubtotal3" class="calced"></td>
</tr>
<tr>
	<td colspan="2">OR Black: (sum of size &times; neighbors)</td>
	<td><input autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" id="blackScore" type="text"/></td>
</tr>
<tr>
	<td colspan="2"><b>Black SUM</b></td>
	<td id="blackSubtotal" class="calced"></td>
</tr>
<tr>
	<td colspan="2"><strong>(Colors - Black) Subtotal</strong></td>
	<td><b autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" id="clackSubtotal" class="calced"></b></td>
</tr>
<tr data-rule="1" class="ruleRow">
	<td colspan="2">Rule #1: <span id="sr0"></span> </td>
	<td><input autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" class="ruleScore" id="rule1" type="text"/></td>
</tr>
<tr data-rule="2" class="ruleRow">
	<td colspan="2">Rule #2: <span id="sr1"></span></td>
	<td><input autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" class="ruleScore" id="rule2" type="text"/></td>
</tr>
<tr data-rule="3" class="ruleRow bigCity">
	<td colspan="2">Rule #3: <span id="sr2"></span></td>
	<td><input autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" class="ruleScore" id="rule3" type="text"/></td>
</tr>
<tr data-rule="4" class="ruleRow biggerCity">
	<td colspan="2">Rule #4: <span id="sr3"></span></td>
	<td><input autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" class="ruleScore" id="rule3" type="text"/></td>
</tr>
<tr data-rule="5" class="ruleRow biggestCity">
	<td colspan="2">Rule #5: <span id="sr4"></span></td>
	<td><input autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" class="ruleScore" id="rule3" type="text"/></td>
</tr>
<tr>
	<td colspan="2"><strong>Scoring Rules SUM</strong></td>
	<td><b id="ruleSubtotal" class="calced"></b></td>
</tr>
<tr>
	<td colspan="2"><em>Scoring Rules Targets SUM</em></td>
	<td><em id="targetSUM" class="calced"></em></td>
</tr>
<tr>
	<td colspan="2"><strong>Total</strong></td>
	<td><b id="total" class="calced"></b></td>
</tr>
</tbody>
</table>


<div class="ready"><hr />

<p>The URL to share this combination is <tt><a id="url"></a></tt>.</p>
</div>

<h2 id="draw-bags">Draw Bags</h2>

<p><label>Number of trios:&nbsp;<input type="number" value="3" min="1" max="6" id="trios"></label> <span class="info">(You don't normally need to change this value.)</span></p>

<p class="info">Click a button below to draw a random pyramid of the desired size.</p>

<div class="draw-bags">

<div id="draw-buttons" class="draw-button-area">
     <button type="button" class="draw off" data-pips="1" id="draw1" title="Draw a Small">:SPN</button>
     <button type="button" class="draw off" data-pips="2" id="draw2" title="Draw a Medium">:MPN</button>
     <button type="button" class="draw off" data-pips="3" id="draw3" title="Draw a Large">:LPN</button>
</div>

<div id="draw-current" class="draw-button-area"><span></span></div>

<p id="draw-record"></p>

</div>


<script type="text/javascript">
(function () {
  "use strict";

  const maxCitySize = 5;
  var model = {ids: [], 
      	       citySize: 3, 
	       trios: 3, 
	       pyramids: [[],[],[]]
  };
  const pyramidLigatures = ["::SPN","::MPN","::LPN"];

 function shuffle(array) {
   for (var i = array.length - 1; i > 0; i--) {
     var j = Math.floor(Math.random() * (i + 1));
     var temp = array[i];
     array[i] = array[j];
     array[j] = temp;
   }
 }

 function getRandom() {
   const arr = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18];
   shuffle(arr);
   return arr.slice(0, model.citySize);
 }

 function randomize() {
   //Select new rules.
   model.ids = getRandom().sort(function (a, b) {return a - b;});
   //Clean up manual selection.
   unselectRules();
   //Set up UI.
   setter();
 }

 function randomizeTrios() {
   //Randomizes the pyramid draw bags.

   //Need to reset the model.
   model.pyramids = [[],[],[]];

   //Make the arrays.
   const trio = ["red","yellow","blue","green","black"];

   for (var p=0; p<3; p++) {
     for (var t=1; t<=model.trios; t++) {
       model.pyramids[p] = model.pyramids[p].concat(trio);
     }
     //After concatting, shuffle.
     shuffle(model.pyramids[p]);
   }

   //Set up UI.
   document.querySelectorAll("button.draw").forEach(elt => {
     elt.classList.remove("off");
   });
   pyramidMover();  //There can be pyramids left in the current box.
   document.querySelector("#draw-record").innerHTML = "";
 }

 function setter() {
    //Sets rules from the randomizer, search param, or manual selection.
   const newRuleIds = model.ids;
   document.getElementById("regularCity").checked = (model.citySize == 3);
   document.getElementById("smallCity").checked = (model.citySize == 2);

   document.getElementById("trios").value = model.trios;

   //Clear existing rule paragraphs and scoring
   const rules = document.querySelectorAll("div.rule");
   rules.forEach( rule => {
     rule.classList.remove("on");
   });
   document.querySelectorAll("table input").forEach( inp => {
     inp.value = "";
   });
   document.querySelectorAll("table span").forEach( elt => {
     elt.innerText = "";
   });
   document.querySelectorAll(".calced").forEach( elt => {
     elt.innerText = "";
   });

   document.querySelectorAll("tr.ruleRow").forEach( elt => {
     elt.style.display = (parseInt(elt.getAttribute("data-rule")) > model.citySize) ? "none" : "table-row";
   });

   document.querySelectorAll(".ready").forEach( elt => elt.style.display = "none" );

   var target = 0;
   newRuleIds.forEach( (number, index) => {
     var ruleDiv = document.querySelector("div#rr" + number);
     ruleDiv.classList.add("on");
     document.querySelector("span#sr" + index).innerText = ruleDiv.querySelector("h3").innerText;
     target += parseInt(ruleDiv.getAttribute("data-target"));
   });

   //Non-cleaner tasks
   if (newRuleIds.length) {
      document.querySelector("#targetSUM").innerText = target;

     //Set the URL.
     const URL = window.location.origin + window.location.pathname + "?" + newRuleIds.join(",");
     window.history.replaceState( {} , "Selected rules", URL);
     document.getElementById("url").setAttribute("href", URL);
     document.getElementById("url").innerText = URL;

     document.querySelectorAll(".ready").forEach( elt => elt.style.display = "block" );
   }

   randomizeTrios();
 };

 function summer() {
   var colorTotal = 0;
   document.querySelectorAll('input.colorScore').forEach((elt) => { 
     colorTotal += parseInt(elt.value) || 0;
   });
   document.querySelector("#colorSubtotal").innerText = colorTotal;

   var blackTotal, blackeye;
   if (document.querySelector("#blackScore").value) {
     //You can fill in your own total, or the individual values.
     blackTotal = parseInt(document.querySelector("#blackScore").value) || 0;
   } else {
     blackTotal = 0;
     for (var i = 1; i <= 3; i++) {
       blackeye = (parseInt(document.getElementById("blackScore" + i).value) || 0) * i;
       document.getElementById("blackSubtotal" + i).innerText = blackeye;
       blackTotal += blackeye;
     }
   }

   document.querySelector("#blackSubtotal").innerText = blackTotal;
   document.querySelector("#clackSubtotal").innerText = (colorTotal - blackTotal);

   var ruleTotal = 0;
   document.querySelectorAll('input.ruleScore').forEach((elt) => { 
     ruleTotal += parseInt(elt.value) || 0;
   });
   document.querySelector("#ruleSubtotal").innerText = ruleTotal;

   const total = (colorTotal - blackTotal) + ruleTotal;
   document.querySelector("#total").innerText = total;
   const target = parseInt(document.querySelector("#targetSUM").innerText) || 0;
   document.querySelector("#total").style.color = (target > total) ? "red" : "green";
 }

 function checkCity() {
   if (document.querySelector("#smallCity").checked) {
     model.citySize = 2;
     model.trios = 2;
   } else if (document.querySelector("#regularCity").checked) {
     model.citySize = 3;
     model.trios = 3;
   }
   //In any other case, trios can vary independently from citySize.

   if (document.querySelector("#unmanual").style.display == "inline-block") {
     //We're selecting manually, so recheck current selection sans event 
     selectRule();
   } else if (model.ids.length) {
     //we had a set of rules, so just start fresh to not confuse the user
     model.ids = [];
     setter();
   } else {
     //Corner case?
     randomize();
   }
 }

 function selectRules() {
   //Reset at the start.
   model.ids = [];
   setter();

   document.querySelector("#ruleList").style.display = "grid";
   document.querySelectorAll("#ruleList input").forEach((elt) => {
     elt.checked = false;
   });

   document.querySelector("#unmanual").style.display = "inline-block";
   document.querySelector("#manual").style.display = "none";
 }
 
 function unselectRules() {
   document.querySelector("#unmanual").style.display = "none";
   document.querySelector("#manual").style.display = "inline-block";

   document.querySelectorAll("#ruleList input").forEach((elt) => {
     elt.checked = false;
   });
   document.querySelector("#ruleList").style.display = "none";
 }
 
 function selectRule(event) {
   //const ruleId = event.target.getAttribute("data-ruleid");

   //count rules
   var rules = document.querySelectorAll("div#ruleList input:checked");

   if (rules.length > maxCitySize) {
     document.getElementById("alert").style.display = "inline-block";
     if (event) {
       event.target.checked = false;
       //recount
       rules = document.querySelectorAll("div#ruleList input:checked");
     }
     setTimeout( function() {document.getElementById("alert").style.display = "none";}, 2000);
   } else {
     document.getElementById("alert").style.display = "none";
   }  

   //for simplicity we reset almost every time
   const ruleIds = [...rules].map(elt => parseInt(elt.getAttribute("data-ruleid")));

   //Model is still empty so this resets.  
   //Possibly not neccesary with rule count restriction turned off.
   //setter();

   ruleIds.forEach( (ruleId) => {
     document.querySelector("div#rr" + ruleId).classList.add("on");
   });

    //no longer restricting city sizes.
    //Commit ids to the model and set up.
    model.ids = ruleIds.sort(function (a, b) {return a - b;});
    model.citySize = model.ids.length;
    setter();
 }

 function setTrios() {
   //Override model with set value, re-randomize (on change).
   model.trios = parseInt(document.querySelector("#trios").value) || model.citySize;
   randomizeTrios();
 }

 function picker(event) {
   if (event.target.classList.contains("off"))
     return;

   //Which button was pushed?
   const pips = parseInt(event.target.getAttribute("data-pips"));
   const pipIndex = pips - 1;
  
   //Also check that array, because if you click too fast you can get here.
   if (model.pyramids[pipIndex].length < 1)
     return;

   //Pop the appropriate array.
   const color = model.pyramids[pipIndex].pop();

   //Move the old one pyramid out of the way.
   pyramidMover();
   
   //Draw the drawn pyramid.
   const newPyramidSpan = document.createElement("span");
   newPyramidSpan.classList.add(color);
   const newPSContent = document.createTextNode(pyramidLigatures[pipIndex]);
   newPyramidSpan.appendChild(newPSContent);

   document.querySelector("#draw-current").appendChild(newPyramidSpan);

   //Check whether we need to disable the button and disable it.
   if (model.pyramids[pipIndex].length)
     return;

   //Disabling.
   document.querySelector("button#draw" + pips).classList.add("off");

   //If this is the last pyramid, copy it to the list.
   if (model.pyramids[0].length == 0 && model.pyramids[1].length == 0 && model.pyramids[2].length == 0)
     setTimeout(pyramidMover, 3000);
 }
 
 function pyramidMover() {
   if (document.querySelector("#draw-current span"))
     document.querySelector("#draw-record").appendChild(document.querySelector("#draw-current span"));
 }

 window.onload = (event) => {
   if (window.location.search) {
     try {
       model.ids = (window.location.search.split("?")[1]).split(",").sort(function (a, b) {return a - b;});
       model.citySize = model.ids.length;
       model.trios = model.ids.length == 2 ? 2 : 3;
       setter();
     } catch(e) {
       randomize();
     }
   } else
     randomize();
 };

 document.querySelector("table").addEventListener('input', summer);
 document.querySelector("#randomize").addEventListener('click', randomize);
 document.querySelector("#manual").addEventListener('click', selectRules);
 document.querySelector("#unmanual").addEventListener('click', unselectRules);
 document.querySelector("#regularCity").addEventListener('change', checkCity);
 document.querySelector("#smallCity").addEventListener('change', checkCity);
 document.querySelector("div#ruleList").addEventListener('change', selectRule);
 document.querySelector("#trios").addEventListener('change', setTrios);
 document.querySelector("#draw-buttons").addEventListener('click', picker);

})();
</script>
</body>
</html>
